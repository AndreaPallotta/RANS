---
- name: Install RANS packages
  hosts: localhost
  become: true
  become_method: sudo
  become_user: "{{ lookup('env', 'USER') }}"
  gather_facts: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

  vars_prompt:
    - name: arangodb_root_password
      prompt: 'Enter a password for the ArangoDB root user'

  pre_tasks:
    - name: Update Repositories
      dnf: update_cache=yes
      become_user: root
      changed_when: false

  tasks:
    - name: Check if Nginx is installed
      shell: which nginx
      args:
        executable: /bin/bash
      register: nginx_exists
      ignore_errors: true
      tags:
        - nginx

    - name: Check if ArangoDB is installed
      shell: which arangodb
      args:
        executable: /bin/bash
      register: arangodb_exists
      ignore_errors: true
      tags:
        - arangodb

    - name: Check if Rust dependencies are installed
      command: 'rpm -q {{ item }}'
      register: rust_dependencies
      with_items:
        - yum-utils
        - epel-release
        - cmake
        - gcc
        - make
        - curl
        - clang
      ignore_errors: true
      tags:
        - rust

    - name: Check if Cargo is installed
      shell: which cargo
      args:
        executable: /bin/bash
      register: cargo_exists
      ignore_errors: true
      tags:
        - rust

    - name: Check if nginx service is running
      ansible.builtin.systemd:
        name: 'nginx'
      register: nginx_status
      ignore_errors: true
      tags:
        - nginx

    - name: Check if arangodb service is running
      ansible.builtin.systemd:
        name: 'arangodb'
      register: arangodb_status
      ignore_errors: true
      tags:
        - arangodb

    - name: Install Nginx
      become_user: root
      when: nginx_exists is failed
      dnf:
        name: nginx
        state: present
      tags:
        - nginx

    - name: Add ArangoDB repository
      when: arangodb_exists is failed
      command: curl -OL https://download.arangodb.com/arangodb310/RPM/arangodb.repo
      args:
        chdir: /etc/yum.repos.d/
      tags:
        - arangodb

    - name: Install ArangoDB Server
      when: arangodb_exists is failed
      dnf:
        name: arangodb3-3.10.5-1.0
        state: present
      tags:
        - arangodb

    - name: Override ArangoDB Default Language
      when: arangodb_exists is failed
      ansible.builtin.copy:
        content: '{"default":"en_US.UTF-8"}'
        dest: /var/lib/arangodb3/LANGUAGE
      tags:
        - arangodb

    - name: Secure installation
      when: arangodb_exists is failed
      expect:
        command: arango-secure-installation
        responses:
          'Please enter a new password for the ArangoDB root user: ': '{{ arangodb_root_password }}\n'
          'Repeat password: ': '{{ arangodb_root_password }}\n'
      tags:
        - arangodb

    - set_fact:
        package_list: "{{ rust_dependencies.results | rejectattr('stderr', 'search', '^$') | map(attribute='item') | list }}"
    - name: Install Rust Dependencies
      dnf:
        name: '{{ item }}'
        state: present
      with_items: '{{ package_list }}'
      when: "'not installed' in rust_dependencies.results[item.index].stderr"
      tags:
        - rust
      ignore_errors: true

    - name: Download Rust Installed
      when: cargo_exists is failed
      get_url:
        url: https://sh.rustup.rs
        dest: /tmp/sh.rustup.rs
        mode: '0755'
        force: true
      tags:
        - rust

    - name: Install Rust
      when: cargo_exists is failed
      shell: /tmp/sh.rustup.rs -y
      args:
        executable: /bin/bash
      tags:
        - rust

    - name: Configure Rust system path variable
      when: cargo_exists is failed
      become: false
      shell: source ~/.profile source {{ lookup('env', 'HOME') }}/.cargo/env
      args:
        executable: /bin/bash
      environment:
        HOME: /home/{{ lookup('env', 'USER') }}
      tags:
        - rust

    - name: Enable and start Nginx service
      when: nginx_status.status.ActiveState != 'active'
      ansible.builtin.systemd:
        name: nginx
        enabled: yes
        state: started
      tags:
        - nginx

    - name: Enable and start ArangoDB service
      when: arangodb_status.status.ActiveState != 'active'
      ansible.builtin.systemd:
        name: arangodb3
        enabled: yes
        state: started
      tags:
        - arangodb

    - name: Configure Firewall
      ansible.posix.firewalld:
        port: '{{ item }}/tcp'
        permanent: yes
        state: enabled
        immediate: yes
      # vars:
      #   ansible_python_interpreter: /usr/bin/python3.6
      tags:
        - firewall
      with_items:
        - 80
        - 8529
        - 3000
